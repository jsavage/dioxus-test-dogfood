# Complete Dioxus Dogfooding Setup - All Required Files

This document contains ALL files you need. Copy each section to the appropriate location.

---

## File 1: `.github/workflows/dogfood.yml`

**Location:** `.github/workflows/dogfood.yml`

```yaml
name: Dogfood Test - Run Setup Script

on:
  push:
    branches: 
      - main
      - master
    paths:
      - 'setup-dioxus-test.sh'
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'setup-dioxus-test.sh'
  workflow_dispatch:

jobs:
  dogfood-test:
    name: Run Setup Script and Commit Output
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Need this to commit back to repo
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better commits
      
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Install Dioxus CLI
        run: |
          if ! command -v dx &> /dev/null; then
            echo "Installing Dioxus CLI..."
            cargo install dioxus-cli
          else
            echo "Dioxus CLI already cached: $(dx --version)"
          fi
      
      - name: Clean previous output
        run: |
          # Remove old generated project if it exists
          if [ -d "generated-project" ]; then
            echo "Removing old generated-project/"
            rm -rf generated-project
          fi
      
      - name: Make setup script executable
        run: chmod +x setup-dioxus-test.sh
      
      - name: Run setup script (non-interactive)
        run: |
          echo "Running setup script..."
          # Pipe 'y' to answer the confirmation prompt
          echo "y" | ./setup-dioxus-test.sh
      
      - name: Move generated project to tracked location
        run: |
          # The script creates dioxus-test/ directory
          # Move it to a tracked location in the repo
          if [ -d "dioxus-test" ]; then
            mv dioxus-test generated-project
            echo "âœ“ Generated project moved to generated-project/"
          else
            echo "ERROR: dioxus-test directory not found!"
            exit 1
          fi
      
      - name: Verify generated files
        run: |
          cd generated-project
          
          echo "Verifying generated files..."
          
          # Check all expected files exist
          FILES=(
            "Cargo.toml"
            "Dioxus.toml"
            "src/main.rs"
            "README.md"
            "deploy.sh"
            ".gitignore"
          )
          
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ“ $file"
            else
              echo "âœ— $file MISSING"
              exit 1
            fi
          done
          
          # Check build output exists
          BUILD_DIR="target/dx/dioxus-test/release/web/public"
          if [ -d "$BUILD_DIR" ]; then
            echo "âœ“ Build output directory exists"
            echo "  Files: $(ls -1 $BUILD_DIR | wc -l)"
          else
            echo "âœ— Build output directory MISSING"
            exit 1
          fi
          
          # Check deployment package
          if [ -f "dioxus-deploy.zip" ]; then
            ZIP_SIZE=$(ls -lh dioxus-deploy.zip | awk '{print $5}')
            echo "âœ“ Deployment package exists ($ZIP_SIZE)"
          else
            echo "âœ— Deployment package MISSING"
            exit 1
          fi
          
          echo ""
          echo "All verification checks passed!"
      
      - name: Create manifest file
        run: |
          cd generated-project
          
          # Create a manifest describing what was generated
          cat > GENERATED_MANIFEST.md << 'MANIFEST_EOF'
          # Generated Project Manifest
          
          This project was automatically generated by the setup script.
          
          ## Generation Details
          
          MANIFEST_EOF
          
          echo "- **Generated at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> GENERATED_MANIFEST.md
          echo "- **Git commit:** ${{ github.sha }}" >> GENERATED_MANIFEST.md
          echo "- **Workflow run:** ${{ github.run_number }}" >> GENERATED_MANIFEST.md
          echo "- **Setup script:** setup-dioxus-test.sh" >> GENERATED_MANIFEST.md
          echo "" >> GENERATED_MANIFEST.md
          echo "## Files Generated" >> GENERATED_MANIFEST.md
          echo "" >> GENERATED_MANIFEST.md
          
          # List all generated files
          find . -type f -not -path './target/*' -not -path './.git/*' | sort >> GENERATED_MANIFEST.md
          
          echo "" >> GENERATED_MANIFEST.md
          echo "## Build Output" >> GENERATED_MANIFEST.md
          echo "" >> GENERATED_MANIFEST.md
          
          BUILD_DIR="target/dx/dioxus-test/release/web/public"
          if [ -d "$BUILD_DIR" ]; then
            echo "Build output location: \`$BUILD_DIR\`" >> GENERATED_MANIFEST.md
            echo "" >> GENERATED_MANIFEST.md
            echo "Files:" >> GENERATED_MANIFEST.md
            echo "\`\`\`" >> GENERATED_MANIFEST.md
            ls -lh "$BUILD_DIR" >> GENERATED_MANIFEST.md
            echo "" >> GENERATED_MANIFEST.md
            ls -lh "$BUILD_DIR/assets/" >> GENERATED_MANIFEST.md
            echo "\`\`\`" >> GENERATED_MANIFEST.md
          fi
          
          echo "" >> GENERATED_MANIFEST.md
          echo "## Deployment Package" >> GENERATED_MANIFEST.md
          echo "" >> GENERATED_MANIFEST.md
          
          if [ -f "dioxus-deploy.zip" ]; then
            ZIP_SIZE=$(ls -lh dioxus-deploy.zip | awk '{print $5}')
            echo "- Package: \`dioxus-deploy.zip\` ($ZIP_SIZE)" >> GENERATED_MANIFEST.md
            echo "- Contents:" >> GENERATED_MANIFEST.md
            echo "\`\`\`" >> GENERATED_MANIFEST.md
            unzip -l dioxus-deploy.zip >> GENERATED_MANIFEST.md
            echo "\`\`\`" >> GENERATED_MANIFEST.md
          fi
      
      - name: Clean up large build artifacts for commit
        run: |
          cd generated-project
          
          # Keep the deployment package but remove the large target directory
          # to avoid bloating the repo (target/ can be 100s of MB)
          if [ -d "target" ]; then
            echo "Removing target/ directory (too large to commit)"
            rm -rf target
          fi
          
          # Keep only the essential generated files
          echo "âœ“ Cleaned up for commit"
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Commit generated project
        run: |
          # Add the generated project
          git add generated-project/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "CHANGES_MADE=false" >> $GITHUB_ENV
          else
            git commit -m "Auto-generated: Dioxus test project from setup script

Generated by workflow run: ${{ github.run_number }}
Commit: ${{ github.sha }}

This project was created by running setup-dioxus-test.sh
and represents the expected output of the setup script."
            
            echo "CHANGES_MADE=true" >> $GITHUB_ENV
            echo "âœ“ Changes committed"
          fi
      
      - name: Push changes
        if: env.CHANGES_MADE == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git push origin HEAD:main
          echo "âœ“ Changes pushed to repository"
      
      - name: Upload deployment package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: dioxus-deployment-package
          path: generated-project/dioxus-deploy.zip
          retention-days: 30
      
      - name: Upload generated source files
        uses: actions/upload-artifact@v4
        with:
          name: generated-source-files
          path: |
            generated-project/
            !generated-project/target/
            !generated-project/.git/
          retention-days: 30
      
      - name: Create summary
        run: |
          cd generated-project
          
          echo "## ğŸ‰ Setup Script Test Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The setup script successfully generated a complete Dioxus project." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cargo.toml | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Dioxus.toml | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| src/main.rs | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| README.md | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| deploy.sh | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| .gitignore | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "dioxus-deploy.zip" ]; then
            ZIP_SIZE=$(ls -lh dioxus-deploy.zip | awk '{print $5}')
            echo "### Deployment Package" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Size:** $ZIP_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- **Ready to deploy:** Yes âœ…" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`dioxus-deployment-package\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Upload to your shared hosting" >> $GITHUB_STEP_SUMMARY
          echo "3. Extract in a folder named \`dioxus\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Access at \`https://yourdomain.com/dioxus/\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The generated project source is also available in the \`generated-project/\` directory of this repository." >> $GITHUB_STEP_SUMMARY

  verify-generated-project:
    name: Verify Generated Project Can Build
    runs-on: ubuntu-latest
    needs: dogfood-test
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}  # Get the latest including any commits from previous job
      
      - name: Wait for previous job to push
        run: sleep 10  # Give previous job time to push
      
      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}
      
      - name: Check if generated project exists
        run: |
          if [ -d "generated-project" ]; then
            echo "âœ“ Generated project found"
          else
            echo "âš  Generated project not found (may not have been committed yet)"
            exit 0  # Don't fail, this is expected on first run
          fi
      
      - name: Set up Rust
        if: success()
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Install Dioxus CLI
        if: success()
        run: cargo install dioxus-cli
      
      - name: Build generated project independently
        if: success()
        run: |
          cd generated-project
          
          echo "Building generated project as an independent test..."
          dx build --release --platform web
          
          BUILD_DIR="target/dx/dioxus-test/release/web/public"
          
          if [ -f "$BUILD_DIR/index.html" ]; then
            echo "âœ“ Independent build successful!"
          else
            echo "âœ— Independent build failed"
            exit 1
          fi
      
      - name: Upload verification artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: verified-independent-build
          path: generated-project/target/dx/dioxus-test/release/web/public/
          retention-days: 7
```

---

## File 2: `README.md`

**Location:** `README.md` (root of repository)

```markdown
# Dioxus Test App - Dogfooding Repository

This repository demonstrates a "dogfooding" approach: the setup script generates a complete Dioxus project, which is automatically committed back to this repository.

## ğŸš€ Quick Start

### Use Generated Project (Fastest)

The `generated-project/` directory contains a ready-to-use Dioxus app:

\`\`\`bash
git clone https://github.com/yourusername/dioxus-test-dogfood.git
cd dioxus-test-dogfood/generated-project
dx serve  # Test locally
\`\`\`

### Run Setup Script Yourself

Generate a fresh project:

\`\`\`bash
./setup-dioxus-test.sh
\`\`\`

## ğŸ“‹ How It Works

1. **Edit** `setup-dioxus-test.sh` (the only file you need to modify)
2. **Push** changes to GitHub
3. **GitHub Actions** runs the script automatically
4. **Generated project** is committed to `generated-project/`
5. **Everyone** gets the latest working project!

## ğŸ“¦ Repository Structure

\`\`\`
dioxus-test-dogfood/
â”œâ”€â”€ setup-dioxus-test.sh         # â† EDIT THIS (source of truth)
â”œâ”€â”€ .github/workflows/
â”‚   â””â”€â”€ dogfood.yml              # â† Automates everything
â”œâ”€â”€ README.md                    # â† This file
â””â”€â”€ generated-project/           # â† AUTO-GENERATED (don't edit!)
    â”œâ”€â”€ Cargo.toml
    â”œâ”€â”€ Dioxus.toml
    â”œâ”€â”€ src/main.rs
    â”œâ”€â”€ dioxus-deploy.zip        # â† Ready to deploy!
    â””â”€â”€ GENERATED_MANIFEST.md    # â† Generation details
\`\`\`

## ğŸ¯ Deployment

### Option 1: From Repository

\`\`\`bash
cd generated-project
# Upload dioxus-deploy.zip to your shared hosting
# Extract in a folder named 'dioxus'
# Access at: https://yourdomain.com/dioxus/
\`\`\`

### Option 2: From GitHub Actions

1. Go to [Actions](../../actions) tab
2. Click latest successful workflow run
3. Download `dioxus-deployment-package` artifact
4. Upload and extract on your hosting

## ğŸ§ª Testing

Every change to `setup-dioxus-test.sh` automatically triggers:

- âœ… Full script execution
- âœ… Project generation
- âœ… Build verification
- âœ… Independent build test
- âœ… Artifact creation

View test results in the [Actions](../../actions) tab.

## ğŸ“ Making Changes

\`\`\`bash
# 1. Edit the setup script
vim setup-dioxus-test.sh

# 2. Commit and push
git add setup-dioxus-test.sh
git commit -m "Update: describe your changes"
git push

# 3. Wait for GitHub Actions to complete
# 4. Pull the auto-generated project
git pull
\`\`\`

## âœ… Golden Rules

| âœ… DO | âŒ DON'T |
|-------|----------|
| Edit `setup-dioxus-test.sh` | Edit files in `generated-project/` |
| Let workflow commit changes | Manually update `generated-project/` |
| Pull after workflow completes | Ignore workflow failures |

## ğŸ” Viewing Results

### In Repository
\`\`\`bash
git pull
cd generated-project
cat GENERATED_MANIFEST.md  # See generation details
\`\`\`

### In GitHub
- **Actions Tab**: Step-by-step workflow logs
- **Artifacts**: Downloadable build packages
- **Summary**: Each run shows generation results

## ğŸ†˜ Troubleshooting

| Problem | Solution |
|---------|----------|
| No `generated-project/` | Wait for workflow to complete, then `git pull` |
| Workflow fails | Check Actions tab for error logs |
| Files not updating | Script output may be identical to previous run |

## ğŸ“š Documentation

- Full setup guide: See comments in `setup-dioxus-test.sh`
- Workflow details: See `.github/workflows/dogfood.yml`
- Generation details: See `generated-project/GENERATED_MANIFEST.md`

## ğŸ“ Learn More

- [Dioxus Documentation](https://dioxuslabs.com/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)

## ğŸ“„ License

MIT
\`\`\`

---

## File 3: `.gitignore`

**Location:** `.gitignore` (root of repository)

\`\`\`
# Local test runs of the script
/dioxus-test/

# Don't ignore generated-project/ - we want to commit it!
# The .gitignore inside generated-project/ will handle that folder

# macOS
.DS_Store

# Editor files
*.swp
*~
.vscode/
.idea/
\`\`\`

---

## Quick Setup Commands

Run these commands to set up your repository:

\`\`\`bash
# 1. Create repository directory
mkdir dioxus-test-dogfood
cd dioxus-test-dogfood

# 2. Initialize git
git init

# 3. Create directory structure
mkdir -p .github/workflows

# 4. Copy setup-dioxus-test.sh here (your existing script)

# 5. Create .github/workflows/dogfood.yml (copy from File 1 above)

# 6. Create README.md (copy from File 2 above)

# 7. Create .gitignore (copy from File 3 above)

# 8. Make script executable
chmod +x setup-dioxus-test.sh

# 9. Initial commit
git add .
git commit -m "Initial commit: Dogfooding setup"

# 10. Create GitHub repository and push
git remote add origin https://github.com/yourusername/dioxus-test-dogfood.git
git branch -M main
git push -u origin main

# 11. Wait for workflow to complete, then pull
git pull
\`\`\`

---

## Summary

You need to create **3 files**:

1. `.github/workflows/dogfood.yml` - The GitHub Actions workflow
2. `README.md` - Repository documentation
3. `.gitignore` - Git ignore rules

Plus your existing `setup-dioxus-test.sh` script.

After pushing, GitHub Actions will automatically run the script and commit the generated project to `generated-project/`.

name: Dogfood Test - Includes Running Setup Script

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'setup-dioxus-test.sh'
      - '.github/workflows/dogfood.yml'  # Add this line to trigger on workflow file changes
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'setup-dioxus-test.sh'
      - '.github/workflows/dogfood.yml'  # Add this here as well
  workflow_dispatch:

jobs:
  dogfood-test:
    name: Run Setup Script and Commit Output
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: Specify OS
        run: echo "Running on UBUNTU 22.04"
      - name: Run setup script
        run: ./setup-dioxus-test.sh
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Cache Cargo
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      
      - name: Install Dioxus CLI
        run: |
          if ! command -v dx &> /dev/null; then
            echo "Installing Dioxus CLI..."
            cargo install dioxus-cli
          else
            echo "Dioxus CLI already cached: $(dx --version)"
          fi
      
      - name: Clean previous output
        run: |
          if [ -d "generated-project" ]; then
            echo "Removing old generated-project/"
            rm -rf generated-project
          fi
      
      - name: Make setup script executable
        run: chmod +x setup-dioxus-test.sh
      
      - name: Run setup script non-interactively
        run: |
          echo "Running setup script..."
          echo "y" | ./setup-dioxus-test.sh
      
      - name: Move generated project to tracked location
        run: |
          if [ -d "dioxus-test" ]; then
            mv dioxus-test generated-project
            echo "âœ“ Generated project moved to generated-project/"
          else
            echo "ERROR: dioxus-test directory not found!"
            exit 1
          fi
      
      - name: Verify generated files
        run: |
          cd generated-project
          
          echo "Verifying generated files..."
          
          FILES=(
            "Cargo.toml"
            "Dioxus.toml"
            "src/main.rs"
            "README.md"
            "deploy.sh"
            ".gitignore"
          )
          
          for file in "${FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ“ $file"
            else
              echo "âœ— $file MISSING"
              exit 1
            fi
          done
          
          BUILD_DIR="target/dx/dioxus-test/release/web/public"
          if [ -d "$BUILD_DIR" ]; then
            echo "âœ“ Build output directory exists"
          else
            echo "âœ— Build output directory MISSING"
            exit 1
          fi
          
          if [ -f "dioxus-deploy.zip" ]; then
            ZIP_SIZE=$(ls -lh dioxus-deploy.zip | awk '{print $5}')
            echo "âœ“ Deployment package exists ($ZIP_SIZE)"
          else
            echo "âœ— Deployment package MISSING"
            exit 1
          fi
      
      - name: Create manifest file
        run: |
          cd generated-project
          
          cat > GENERATED_MANIFEST.md << 'MANIFEST_EOF'
          # Generated Project Manifest
          
          This project was automatically generated by the setup script.
          
          ## Generation Details
          
          MANIFEST_EOF
          
          echo "- **Generated at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> GENERATED_MANIFEST.md
          echo "- **Git commit:** ${{ github.sha }}" >> GENERATED_MANIFEST.md
          echo "- **Workflow run:** ${{ github.run_number }}" >> GENERATED_MANIFEST.md
          echo "- **Setup script:** setup-dioxus-test.sh" >> GENERATED_MANIFEST.md
          echo "" >> GENERATED_MANIFEST.md
          echo "## Files Generated" >> GENERATED_MANIFEST.md
          echo "" >> GENERATED_MANIFEST.md
          
          find . -type f -not -path './target/*' -not -path './.git/*' | sort >> GENERATED_MANIFEST.md
          
          echo "" >> GENERATED_MANIFEST.md
          echo "## Build Output" >> GENERATED_MANIFEST.md
          echo "" >> GENERATED_MANIFEST.md
          
          BUILD_DIR="target/dx/dioxus-test/release/web/public"
          if [ -d "$BUILD_DIR" ]; then
            echo "Build output location: \`$BUILD_DIR\`" >> GENERATED_MANIFEST.md
            echo "" >> GENERATED_MANIFEST.md
            echo "Files:" >> GENERATED_MANIFEST.md
            echo "\`\`\`" >> GENERATED_MANIFEST.md
            ls -lh "$BUILD_DIR" >> GENERATED_MANIFEST.md
            echo "" >> GENERATED_MANIFEST.md
            ls -lh "$BUILD_DIR/assets/" >> GENERATED_MANIFEST.md
            echo "\`\`\`" >> GENERATED_MANIFEST.md
          fi
          
          echo "" >> GENERATED_MANIFEST.md
          echo "## Deployment Package" >> GENERATED_MANIFEST.md
          echo "" >> GENERATED_MANIFEST.md
          
          if [ -f "dioxus-deploy.zip" ]; then
            ZIP_SIZE=$(ls -lh dioxus-deploy.zip | awk '{print $5}')
            echo "- Package: \`dioxus-deploy.zip\` ($ZIP_SIZE)" >> GENERATED_MANIFEST.md
            echo "- Contents:" >> GENERATED_MANIFEST.md
            echo "\`\`\`" >> GENERATED_MANIFEST.md
            unzip -l dioxus-deploy.zip >> GENERATED_MANIFEST.md
            echo "\`\`\`" >> GENERATED_MANIFEST.md
          fi
      
      - name: Clean up large build artifacts for commit
        run: |
          cd generated-project
          
          if [ -d "target" ]; then
            echo "Removing target/ directory (too large to commit)"
            rm -rf target
          fi
      
      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Commit generated project
        run: |
          git add generated-project/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
            echo "CHANGES_MADE=false" >> $GITHUB_ENV
          else
            git commit -m "Auto-generated: Dioxus test project from setup script

          Generated by workflow run: ${{ github.run_number }}
          Commit: ${{ github.sha }}
          
          This project was created by running setup-dioxus-test.sh
          and represents the expected output of the setup script."
            
            echo "CHANGES_MADE=true" >> $GITHUB_ENV
          fi
      
      - name: Push changes
        if: env.CHANGES_MADE == 'true' && github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          git push origin HEAD:main
          echo "âœ“ Changes pushed to repository"
      
      - name: Upload deployment package as artifact
        uses: actions/upload-artifact@v4
        with:
          name: dioxus-deployment-package
          path: generated-project/dioxus-deploy.zip
          retention-days: 30
      
      - name: Upload generated source files
        uses: actions/upload-artifact@v4
        with:
          name: generated-source-files
          path: |
            generated-project/
            !generated-project/target/
            !generated-project/.git/
          retention-days: 30
      
      - name: Create summary
        run: |
          cd generated-project
          
          echo "## ðŸŽ‰ Setup Script Test Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The setup script successfully generated a complete Dioxus project." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Generated Files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| File | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Cargo.toml | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| Dioxus.toml | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| src/main.rs | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| README.md | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| deploy.sh | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "| .gitignore | âœ… |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "dioxus-deploy.zip" ]; then
            ZIP_SIZE=$(ls -lh dioxus-deploy.zip | awk '{print $5}')
            echo "### Deployment Package" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Size:** $ZIP_SIZE" >> $GITHUB_STEP_SUMMARY
            echo "- **Ready to deploy:** Yes âœ…" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`dioxus-deployment-package\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Upload to your shared hosting" >> $GITHUB_STEP_SUMMARY
          echo "3. Extract in a folder named \`dioxus\`" >> $GITHUB_STEP_SUMMARY
          echo "4. Access at \`https://yourdomain.com/dioxus/\`" >> $GITHUB_STEP_SUMMARY

  verify-generated-project:
    name: Verify Generated Project Can Build
    runs-on: ubuntu-latest
    needs: dogfood-test
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}
      
      - name: Wait for previous job to push
        run: sleep 10
      
      - name: Pull latest changes
        run: git pull origin ${{ github.ref_name }}
      
      - name: Check if generated project exists
        run: |
          if [ -d "generated-project" ]; then
            echo "âœ“ Generated project found"
          else
            echo "âš  Generated project not found"
            exit 0
          fi
      
      - name: Set up Rust
        if: success()
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      
      - name: Install Dioxus CLI
        if: success()
        run: cargo install dioxus-cli
      
      - name: Build generated project independently
        if: success()
        run: |
          cd generated-project
          
          echo "Building generated project as an independent test..."
          dx build --release --platform web
          
          BUILD_DIR="target/dx/dioxus-test/release/web/public"
          
          if [ -f "$BUILD_DIR/index.html" ]; then
            echo "âœ“ Independent build successful!"
          else
            echo "âœ— Independent build failed"
            exit 1
          fi
      
      - name: Upload verification artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: verified-independent-build
          path: generated-project/target/dx/dioxus-test/release/web/public/
          retention-days: 7
